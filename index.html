<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>LyricsTTE Web</title>

<style>
    html,body{
        height :100%;
        margin:0;
    }
    #Screen
    {
        display: flex;
        flex-direction: column;
        height :100%;
        padding:2px;
        box-sizing: border-box;
    }
    #WaveDisplay
    {
        width: 100%;
        resize: vertical;
        overflow: hidden;

        flex: 0 0 auto;
    }
    #WaveCanvas
    {
        background-color: black;
    }

    #TabLabels
    {
        flex: 0 1 auto;
    }
    input[name="mode_tab"] , input[name="stamp_line"]
    {
        display: none;
    }
    .TabContent{
        display: none;
    }
    .tab_label
    {
        margin:0px 8px;
        border-bottom: 3px solid #5ab4bd;
        background-color: #d9d9d9;
    }
    #TabStamp:checked ~ * #TabStampLabel ,
    #TabEdit:checked ~ * #TabEditLabel ,
    #TabTune:checked ~ * #TabTuneLabel 
    {
        background-color: #5ab4bd;
        color: #fff;
    }
    #TabStamp:checked ~ #TagStamper ,
    #TabEdit:checked ~ #TextEditor ,
    #TabTune:checked ~ #TimeTuner
    {
        display:flex;
    }

    #TextEditor
    {
        height :100%;
        flex-direction: column;

        flex: 1 1 auto;
    }    
    #TextArea
    {
        height: 100%;
        resize:none;
        flex:1 1 auto;
        margin: 4px;
        padding: 4px;
    }

    #TagStamper , #TimeTuner
    {
        height: 100%;
        flex: 1 1 auto;
        overflow-y :scroll;
        border: black 1px solid;
        margin: 4px;
    }
    ol
    {
        list-style-type: decimal-leading-zero;
        width: 100%;
        margin: 2px 0;
    }
    li
    {
        border-bottom: solid 1px #cccccc;
        line-height: 2;
    }
    li::marker
    {

    }
    .list_time
    {
        background-color:#eeeeee ;
        margin-left: 5px;
        text-align: center;
        flex: 0 0 6em;
    }
    .list_text
    {
        padding-left: 5px;
        flex: 1 1 auto;
    }
    input:checked ~ .list_time , input:checked ~ .list_text
    {
        background-color:#FFDDDD ;
    }
    .flex
    {
        display: flex;
    }

</style>

</head>
<body>
<div id="Screen">
    <div id="Player">
        <audio id="AudioPlayer" preload controls>
        </audio>
    </div>
    <div id="WaveDisplay">
        <canvas id="WaveCanvas"></canvas>
    </div>
    <input type="radio" id="TabStamp" name="mode_tab">
    <input type="radio" id="TabEdit" name="mode_tab" checked>
    <input type="radio" id="TabTune" name="mode_tab">
    <div id="TabLabels">
        <label for="TabStamp" id="TabStampLabel" class="tab_label">TagStamp</label>
        <label for="TabEdit" id="TabEditLabel" class="tab_label">TextEdit</label>
        <label for="TabTune" id=TabTuneLabel class="tab_label">TimeTune</label>
    </div>
    <div id="TagStamper" class="TabContent">
        <ol id="StamperList">
        </ol>
    </div>
    <div id="TextEditor" class="TabContent">
        <textarea id="TextArea"></textarea>
        <div id="TextEditButtons">
            <button id="Download" type="button">ダウンロード</button>
        </div>
    </div>
    <div id="TimeTuner" class="TabContent">
        <ol id="TunerList">
        </ol>
    </div>
</div>
<script type='text/javascript' src='WaveViewer.js' defer></script>
<script type='text/javascript' src='Lyrics.js' defer></script>
<script defer>

(function LrCDownload(){
document.getElementById('Download').addEventListener('click', (e)=>{
    e.preventDefault();
    const text = document.getElementById('TextArea').value;
    const blob = new Blob([text], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    document.body.appendChild(a);

    const now = new Date();
    const y = now.getFullYear();
    const m = ('00' + (now.getMonth()+1)).slice(-2);
    const d = ('00' + now.getDate()).slice(-2);
    const h = ('00' + now.getHours()).slice(-2);
    const mi = ('00' + (now.getMinutes()+1)).slice(-2);

    a.download = y + "-" + m + d + "-" + h + mi + '.lrc';
    a.href = url;
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
});
}());



const audio = document.getElementById("AudioPlayer");
const canvas = document.getElementById( 'WaveCanvas' );
const textarea = document.getElementById('TextArea');

var waveViewer;
var Magnification = 500;
var WaveViewTime = 0;
var TuneModeDraw = null;

var EditModeInitializer;
var StampModeInitializer;
var TuneModeInitializer;

function DrawWaveView()
{
    if (TuneModeDraw)
    {
        TuneModeDraw();
        return;
    }

    const width  = canvas.width;
    const height = canvas.height;
    const nowpoint = Math.floor(width * 0.3)
    waveViewer.DrawCanvas(canvas,WaveViewTime - (nowpoint * 1000/Magnification),1000/Magnification);
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "white";
    ctx.fillRect(nowpoint,0,1,height);
}



(function AudioEvent(){

function Tick(timestamp)
{
    WaveViewTime = audio.currentTime * 1000;
    DrawWaveView();
    if (!audio.paused)
        window.requestAnimationFrame(Tick);
}
audio.addEventListener("timeupdate",()=>{
    if (TuneModeDraw == null)
        WaveViewTime = audio.currentTime * 1000;
    DrawWaveView();
});
audio.addEventListener("play",()=>{
    if (TuneModeDraw == null)
        window.requestAnimationFrame(Tick);
});
audio.addEventListener("pause", ()=>{
});
audio.addEventListener("ended",()=>{
});
}());

(function WaveViewerMouseEvent(){
    var x;
    var playing;
    const canvas = document.getElementById( 'WaveCanvas' );
    canvas.ondragstart = (e)=>{return false;}
    canvas.addEventListener("mousedown", (e)=>{
        if (TuneModeDraw == null)
        {
            playing = !audio.paused;
            audio.pause();
        }
        x = e.pageX;
        function onMouseMove(e) {
            WaveViewTime -=  (e.pageX - x) * (1000 / 500);
            if (WaveViewTime < 0)
                WaveViewTime = 0;

            //なんかここでエラーが出てるっぽいんだが全くわからん。
            //とりあえずテスト用ファイルのデータ異常ではないか？という事にしておく。
            //「魔王魂 ショート シャイニングスター.mp3」の0.65秒あたりに設定すると、
            //以後、イベント"timeupdate"が発生しなくなる。play()もできなくなるっぽい
            //コントローラーで再生しなおすと元に戻る。
//            audio.currentTime = time;
            x = e.pageX;
            DrawWaveView();
        }
        function onMouseUp(e){
            if (TuneModeDraw == null)
            {
                audio.currentTime = WaveViewTime / 1000;
                if (playing)
                    audio.play();
            }
            document.removeEventListener('mousemove', onMouseMove, false);
            document.removeEventListener('mouseup', onMouseUp, false);
        }
        document.addEventListener("mousemove",onMouseMove, false);
        document.addEventListener("mouseup",onMouseUp, false);
    }, false);
}());

(function CanvasResize(){
const container = document.getElementById( 'WaveDisplay' );
var queue = null;
const wait = 300;

//これがない（＝CSS指定のresizeで一度リサイズしない）と、何故かwindowのリサイズの度に7pxずつ増えていく
container.style.height = container.offsetHeight + "px";

setCanvasSize();

window.addEventListener( 'resize', function() {
    clearTimeout( queue );
    queue = setTimeout(function() {setCanvasSize();}, wait );
}, false );

const observer = new MutationObserver(() => {
    clearTimeout( queue );
    queue = setTimeout(function() {
        setCanvasSize();
    }, wait );
});
observer.observe(container, {
    attriblutes: true,
    attributeFilter: ["style"]
});
// Canvasサイズをコンテナの100%に 
function setCanvasSize() {
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    var ctx = canvas.getContext("2d");
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if (waveViewer)
        waveViewer.DrawCanvas(canvas,audio.currentTime*1000,1000/500);

}
}());


(function ModeShifter(){

const tab_edit = document.getElementById("TabEdit");
const tab_stamp = document.getElementById("TabStamp");
const tab_tune = document.getElementById("TabTune");

var LastMode = "edit";

function TabChange(e)
{
    switch (LastMode)
    {
        case "edit":
            if (tab_edit.checked) return;
            EditModeInitializer.Terminalize();
        break;
        case "stamp":
            if (tab_stamp.checked) return;
            StampModeInitializer.Terminalize();
        break;
        case "tune":
            if (tab_tune.checked) return;
            TuneModeInitializer.Terminalize();
        break;
    }
    if (tab_edit.checked)
    {
        EditModeInitializer.Initialize();
        LastMode = "edit";
    }
    else if (tab_stamp.checked)
    {
        StampModeInitializer.Initialize();
        LastMode = "stamp";
    }
    else if (tab_tune)
    {
        TuneModeInitializer.Initialize();
        LastMode = "tune";
    }
}

tab_edit.addEventListener("change",TabChange);
tab_stamp.addEventListener("change",TabChange);
tab_tune.addEventListener("change",TabChange);

}());


(function TagStamper(){

const list = document.getElementById('StamperList');

function keydown(e)
{
    e.preventDefault();

    const input = list.querySelector("input:checked");
    const label = input ? input.parentElement : null;
    const item = label ? label.parentElement : null;

    switch (e.code)
    {
        case "KeyA":case "ArrowLeft":
        if (item)
            {
                let i = item
                while (i.previousElementSibling)
                {
                    i = i.previousElementSibling;
                    const time = i.querySelector("label").dataset.starttime;
                    if (time >= 0)
                    {
                        audio.currentTime = time / 1000;
                        i.querySelector("input").checked = true;
                        i.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
                        break;
                    }
                }
            }
        break;
        case "KeyD":case "ArrowRight":
            if (item)
            {
                let i = item
                while (i.nextElementSibling)
                {
                    i = i.nextElementSibling;
                    const time = i.querySelector("label").dataset.starttime;
                    if (time >= 0)
                    {
                        audio.currentTime = time / 1000;
                        i.querySelector("input").checked = true;
                        i.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
                        break;
                    }
                }
            }
        break;
        case "KeyW":case "ArrowUp":
            if (item && item.previousElementSibling)
            {
                item.previousElementSibling.querySelector("input").checked = true;
                item.previousElementSibling.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
            }
        break;
        case "KeyS":case "ArrowDown":
            if (item && item.nextElementSibling)
            {
                item.nextElementSibling.querySelector("input").checked = true;
                item.nextElementSibling.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
            }
        break;

        case "Space":
        case "Enter":
            if (item)
            {
                label.dataset.starttime = audio.currentTime * 1000;
                const time_span = item.querySelector(".list_time");
                time_span.textContent = TimeTagElement.TimeString(label.dataset.starttime);

                if (item.nextElementSibling)
                {
                    item.nextElementSibling.querySelector("input").checked = true;
                    item.nextElementSibling.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
                }
            }
        break;
        case "Delete":
            if (item)
            {
                const time_span = item.querySelector(".list_time");
                time_span.textContent = ""
            }
        break;
        
        case "KeyZ":
            audio.currentTime = (audio.currentTime - 1 < 0) ? 0 : audio.currentTime - 1;
        break;
        case "KeyX":
            if (audio.paused)
                audio.play();
            else
                audio.pause();
        break;
        case "KeyC":
            audio.currentTime = audio.currentTime + 1;
        break;
    }
}

function Initialize()
{
    const TimeTagList = new LyricsContainer(textarea.value);
    selected = 0;

    TimeTagList.lines.forEach(line => {
        const li = document.createElement("li");

        const label = document.createElement("label");
        label.classList.add("flex");
        label.textContent = "　";
        label.dataset.starttime = line.starttime;
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "stamp_line";
        label.appendChild(radio);

        const starttime = document.createElement("span");
        starttime.textContent = TimeTagElement.TimeString(line.starttime);
        starttime.classList.add("list_time");

        const text = document.createElement("span");
        text.textContent = line.text;
        text.classList.add("list_text");

        label.appendChild(starttime);
        label.appendChild(text);
        li.appendChild(label);
        list.appendChild(li);
    });
    list.querySelector("input").checked = true;

    document.addEventListener("keydown",keydown,false);
}

function Terminalize()
{
    let text = "";
    for (let i = 0; i < list.children.length;i++)
    {
        const item = list.children[i];
        const time_span = item.querySelector(".list_time");
        const text_span = item.querySelector(".list_text");
        text += time_span.textContent + text_span.textContent + "\n";
    }
    textarea.value = text.slice(0,-1);
    while (list.firstChild)
        list.firstChild.remove();
    document.removeEventListener("keydown",keydown,false);
}

StampModeInitializer = {Initialize:Initialize,Terminalize:Terminalize};

}());

(function TextEditor(){

function Initialize()
{
}
function Terminalize()
{

}
EditModeInitializer = {Initialize:Initialize,Terminalize:Terminalize};
}());

(function TimeTuner(){

const list = document.getElementById('TunerList');

function keydown(e)
{
    e.preventDefault();

    const input = list.querySelector("input:checked");
    const label = input ? input.parentElement : null;
    const item = label ? label.parentElement : null;

    switch (e.code)
    {
        case "KeyA":case "ArrowLeft":
        if (item)
            {
                let i = item
                while (i.previousElementSibling)
                {
                    i = i.previousElementSibling;
                    const time = i.querySelector("label").dataset.starttime;
                    if (time >= 0)
                    {
                        audio.currentTime = time / 1000;
                        i.querySelector("input").checked = true;
                        i.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
                        break;
                    }
                }
            }
        break;
        case "KeyD":case "ArrowRight":
            if (item)
            {
                let i = item
                while (i.nextElementSibling)
                {
                    i = i.nextElementSibling;
                    const time = i.querySelector("label").dataset.starttime;
                    if (time >= 0)
                    {
                        audio.currentTime = time / 1000;
                        i.querySelector("input").checked = true;
                        i.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
                        break;
                    }
                }
            }
        break;
        case "KeyW":case "ArrowUp":
            if (item && item.previousElementSibling)
            {
                item.previousElementSibling.querySelector("input").checked = true;
                item.previousElementSibling.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
            }
        break;
        case "KeyS":case "ArrowDown":
            if (item && item.nextElementSibling)
            {
                item.nextElementSibling.querySelector("input").checked = true;
                item.nextElementSibling.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"})
            }
        break;

        case "Space":
        case "Enter":
            if (item)
            {
            }
        break;
        case "Delete":
            if (item)
            {
            }
        break;
        
        case "KeyZ":
        break;
        case "KeyX":
        break;
        case "KeyC":
        break;
    }
}


function TimeTunerDraw()
{
    const width  = canvas.width;
    const height = canvas.height;
    const nowpoint = Math.floor(width * 0.3)
    waveViewer.DrawCanvas(canvas,WaveViewTime - (nowpoint * 1000/Magnification),1000/Magnification);
    const ctx = canvas.getContext("2d");

//    ctx.fillStyle = "white";
//    ctx.fillRect(nowpoint,0,1,height);
}

function Initialize()
{
    const TimeTagList = new LyricsContainer(textarea.value);
    selected = 0;

    TimeTagList.lines.forEach(line => {
        const li = document.createElement("li");

        const label = document.createElement("label");
        label.classList.add("flex");
        label.textContent = "　";
        label.dataset.starttime = line.starttime;
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "stamp_line";
        label.appendChild(radio);

        const starttime = document.createElement("span");
        starttime.textContent = TimeTagElement.TimeString(line.starttime);
        starttime.classList.add("list_time");

        const text = document.createElement("span");
        text.textContent = line.text;
        text.classList.add("list_text");

        label.appendChild(starttime);
        label.appendChild(text);
        li.appendChild(label);
        list.appendChild(li);
    });
    list.querySelector("input").checked = true;

    document.addEventListener("keydown",keydown,false);
    TuneModeDraw = TimeTunerDraw;
    WaveViewTime = audio.currentTime;
}

function Terminalize()
{
    TuneModeDraw = null;
    let text = "";
    for (let i = 0; i < list.children.length;i++)
    {
        const item = list.children[i];
        const time_span = item.querySelector(".list_time");
        const text_span = item.querySelector(".list_text");
        text += time_span.textContent + text_span.textContent + "\n";
    }
    textarea.value = text.slice(0,-1);
    while (list.firstChild)
        list.firstChild.remove();
    document.removeEventListener("keydown",keydown,false);
}

TuneModeInitializer = {Initialize:Initialize,Terminalize:Terminalize};

}());




(function FilesDrop(){
var droparea = document.createElement("div")
	
	function showDroparea(){
        droparea.style.cssText = "all: initial;\
                                  position: fixed;\
                                  top:0;left:0;\
                                  z-index: 1000;\
                                  width: 100%;\
                                  height: 100%;\
                                  box-sizing: border-box;\
                                  display: block;\
                                  border: 8px dashed purple;"
	}
	
	function hideDroparea(){
        droparea.style.cssText = "all: initial;\
                                  position: fixed;\
                                  top:0;left:0;\
                                  z-index: 1000;\
                                  width: 100%;\
                                  height: 100%;\
                                  box-sizing: border-box;\
                                  display: none;";
    }
	
	droparea.ondragleave = e => {
		e.preventDefault();
		hideDroparea();
	};
	
	window.addEventListener("dragover", e => e.preventDefault(), false)
	window.addEventListener("dragenter", e => {
		e.preventDefault();
		showDroparea();
	}, false);
	window.addEventListener("drop", e => {
		e.preventDefault();
		hideDroparea();

        DropFiles(e.dataTransfer.files);
	}, false);
	
	document.body.appendChild(droparea);


function DropFiles(files)
{
    let audioread = false;
    let textread = false;
    for (let i = 0;i < files.length;i++)
    {
        const file = files[i]
        if (file.type.indexOf("audio/") == 0)
        {
            console.log("drop audio file:" + file.name);
            if (audioread)
                continue;
            audio.src = window.URL.createObjectURL(file);
            var reader = new FileReader();
            reader.onload = () => {
                WaveViewTime = 0;
                waveViewer = new WaveViewer(reader.result,DrawWaveView);

                const ctx = canvas.getContext("2d");
                ctx.font = canvas.height / 2 + "px sans-serif";
                ctx.fillStyle = "white";
                ctx.fillText("Now Loading...", 0, canvas.height * 3 / 4);
            };
            reader.readAsArrayBuffer(file);
            audioread = true;
        }
        else if (file.type.indexOf("text/") == 0 || file.name.match(/\.lrc$/i))
        {
            console.log("drop text file:" + file.name);
            const editmode = document.getElementById( 'TabEdit' ).checked;
            if (editmode && !textread)
            {
                let reader = new FileReader();
                reader.readAsText(file);
                reader.onload = ()=> {
                    textarea.value = reader.result;

                }
                textread = true;
            }
        }
        else
        {
            console.log("ignore drop file:" + file.name);
        }
    }
}
})();



</script>
</body>
</html>